import{r as a,u as re,a as ae,s as E,j as r}from"./index-D4x5zLeu.js";import{F as ie,f as ne,t as C,P as se}from"./Publicar-BgUWZZLU.js";/* empty css             */function oe(){const x=re(),{server:y,navigate:S}=x,U=ae(),[T,L]=a.useState(!1),c=a.useRef(!1),R=a.useRef(),[B,_]=a.useState("Upload"),[$,k]=a.useState(!1),[D,I]=a.useState(!1),[P,O]=a.useState(0),[f,h]=a.useState([{titulo:"",input:a.createRef()}]),[v,g]=a.useState(!1),[H,M]=a.useState(!1),[W,N]=a.useState(!1),p=a.useRef(new ie),d={titulo:a.useRef(null),imagem:a.useRef(null),imagem_view:a.useRef(null)},G=()=>{N(!0);const t=setTimeout(()=>{N(!1),clearTimeout(t)},2e3)},J=()=>{M(!0);const t=setTimeout(()=>{M(!1),clearTimeout(t)},2e3)},[b,F]=a.useState({src:E,width:"100%",height:"100%"}),j=t=>{if(typeof t=="string"){const e=new Image;e.onload=()=>{const n=d.imagem_view.current.offsetWidth,o=d.imagem_view.current.offsetHeight;var s=e.width,i=e.height;n/s*i>o?(s=o/i*s,i=o):(i=n/s*i,s=n),F({src:t,width:s,height:i})},e.src=t}else F({src:E,width:window.innerWidth,height:window.innerHeight/1280*720})},z=t=>{const e=t.target.files[0];if(e){const n=new FileReader;n.onloadend=()=>{const o=n.result instanceof ArrayBuffer?n.result:new ArrayBuffer(0),s=new Uint8Array(o),i={jpeg:[255,216,255],png:[137,80,78,71,13,10,26,10],gif:[71,73,70]};let u=null;for(const[m,Z]of Object.entries(i))if(Z.every((ee,te)=>ee===s[te])){u=m;break}if(u&&u=="jpeg"){_(e.name);const m=new FileReader;m.onloadend=()=>{j(m.result)},m.readAsDataURL(e)}else j(null),t.target.value="",J()},n.readAsArrayBuffer(e)}},q=t=>{var e;c.current?e=Math.round(t.loaded*100/t.total)==100?99:Math.round(t.loaded*100/t.total):l.current.executed?e=50+(Math.round(t.loaded*100/t.total)>=100?49:Math.round(t.loaded*100/t.total/2)):e=Math.round(t),I(!0),O(e)},K=a.useCallback(async t=>{if(t.preventDefault(),v||G(),!v)return;var e=new FormData;const n=d.imagem.current.files[0];if(e.append("type","option"),c.current&&e.append("id",R.current.id.toString()),n&&e.append("imagem",n),n&&e.append("imagens_edit","true"),e.append("titulo",d.titulo.current.value),!c.current){for(const o of f){const s=o.input.current.files[0];if(s.type=="audio/x-m4a")A({progress:1}),e.append("arquivos[]",s,s.name.split(".").slice(0,-1).join(".")+".m4a");else{const i="input"+s.name.split(".").slice(-1).join(".");await p.current.writeFile(i,await ne(s)),console.log("aian2"),await p.current.exec(["-i",i,"-vn","-c:a","aac","output.m4a"]),console.log("foie");const u=new Uint8Array(await p.current.readFile("output.m4a"));await p.current.deleteFile(i),await p.current.deleteFile("output.m4a");const m=new Blob([u.buffer],{type:"audio/m4a"});e.append("arquivos[]",m,s.name.split(".").slice(0,-1).join(".")+".m4a")}}l.current.executed=!0}U.post(y+"/admin/musicas_cadastro?type="+(c.current?"edit":"cadastro"),e,c.current?{arquivo:!0}:{arquivo:!0,porcentagem:q}).then(o=>{if(o.error)x.setRedirectError(o.error);else if(o.data.result=="true"){if(c.current){const i=new URLSearchParams(location.search);if(i.has("origin"))S(decodeURIComponent(i.get("origin")));else{const u=location.pathname.split("_");S(u[0]+"_lista")}c.current=!1,R.current=void 0}I(!1),l.current.executed=!1,k(!0);var s=setTimeout(()=>{k(!1),clearTimeout(s)},2e3);d.titulo.current.value="",d.imagem.current.value="",_("Upload"),h([{titulo:"",input:a.createRef()}]),j(null)}})},[f,v]),A=a.useCallback(({progress:t})=>{l.current.finished==-1&&(l.current.finished=0);const e=50/l.current.length;q(e*l.current.finished+t/1*e),t==1&&l.current.length>l.current.finished&&l.current.finished++,l.current.length==l.current.finished&&(l.current.finished=-1)},[f]);c.current=location.pathname=="/admin/musicas_edit";const l=a.useRef({length:0,finished:0,executed:!1});a.useEffect(()=>{x.setSelected("publicar"),L(c.current),c.current?(g(!0),U.post(y+"/admin/musicas_edit"+location.search,{type:"info"}).then(t=>{if("post_edit"in t.data){d.imagem.current.required=!1;const e=t.data.post_edit[0];d.titulo.current.value=e.titulo,e.arquivo=JSON.parse(e.arquivo),h(Array.from({length:e.arquivo.length},(n,o)=>({titulo:e.arquivo[o].replace(/\.[^/.]+$/,""),input:a.createRef()}))),R.current=e,j(y+"/images/"+encodeURIComponent(e.imagem))}})):(async()=>{const t="https://unpkg.com/@ffmpeg/core-mt@0.12.6/dist/esm";p.current.on("progress",A),await p.current.load({coreURL:await C(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await C(`${t}/ffmpeg-core.wasm`,"application/wasm"),workerURL:await C(`${t}/ffmpeg-core.worker.js`,"text/javascript")}),console.log("carregado")})()},[]);const Q=()=>{g(!1),h(t=>[...t,{titulo:"",input:a.createRef()}])},w=a.useRef([]);a.useEffect(()=>{if(f.length>1){for(const t of w.current){const e=new DataTransfer;e.items.add(t[1]),f[t[0]].input.current.files=e.files}w.current=[]}},[f]);const V=a.useCallback(t=>{if(!c.current){var e=0;h(n=>{const o=n[t].input.current.files.length;if(n=n.map((i,u)=>{if(t==u&&i.input.current.files.length>0){const m=i.input.current.files.length;return e+=m,u==n.length-1&&e==n.length+m-1&&g(!0),{...i,titulo:i.input.current.files[0].name.replace(/\.[^/.]+$/,"")}}else if(i.titulo!=""&&i.input.current.files.length>0)e++,u==n.length-1&&e==n.length&&g(!0);else if(i.titulo!=""&&i.input.current.files.length==0)return g(!1),{...i,titulo:""};return i}),o>0){const i=[];w.current=[];for(var s=1;s<o;s++){const u={titulo:n[t].input.current.files[s].name.replace(/\.[^/.]+$/,""),input:a.createRef()};w.current.push([t+s,n[t].input.current.files[s]]),i.push(u)}n.splice(t+1,0,...i)}return l.current.length=n.length,n})}},[f]),X=a.useCallback(t=>{c.current||f[t].input.current.click()},[f]),Y=t=>{t>0&&!c.current&&h(e=>(e.length>1&&(e.splice(t,1),g(!0)),l.current.length=e.length,[...e]))};return r.jsx("div",{id:"pg",className:"mc",children:r.jsxs("div",{id:"dt",className:"fechado",children:[r.jsx(se,{}),r.jsx("div",{id:"msg1",children:"Cadastrar música"}),r.jsxs("form",{onSubmit:K,children:[r.jsx("label",{children:"Título"}),r.jsx("input",{ref:d.titulo,className:"input",id:"titulo",placeholder:"Insira um título",required:!0}),r.jsx("label",{children:"Música"}),r.jsx("div",{className:"list-music"+(T?" edit":""),children:f.map((t,e)=>r.jsxs("div",{className:"item-music"+(e==0?" first":""),children:[r.jsx("div",{className:"count-music",children:e+1}),r.jsx("div",{className:"title-music",children:t.titulo}),r.jsx("input",{onChange:()=>{V(e)},ref:t.input,className:"input-music",type:"file",accept:"audio/*",multiple:!0}),r.jsx("div",{onClick:()=>{X(e)},className:"add-music",children:"+"}),r.jsx("div",{onClick:()=>{Y(e)},className:"remove-music",children:"-"})]},e))}),r.jsx("div",{style:{display:v?"block":"none"},id:"add-list-music",onClick:Q,children:"Adicionar"}),r.jsx("label",{children:"Capa"}),r.jsxs("div",{id:"imagem-div",children:[r.jsx("div",{ref:d.imagem_view,id:"imagem-view",children:r.jsx("img",{className:"col-12 col-md-6",style:{width:b.width,height:b.height},src:b.src})}),r.jsx("input",{className:"file",ref:d.imagem,onChange:z,type:"file",accept:"image/jpg, image/jpeg",required:!0}),r.jsx("div",{id:"imagem-pt",children:r.jsx("div",{id:"imagem",onClick:()=>{d.imagem.current.click()},children:r.jsx("div",{className:"txt-1",children:B})})})]}),r.jsx("button",{type:"submit",id:"button",children:"Enviar"})]}),r.jsx("div",{id:"uploadd",style:{display:D?"flex":"none"},children:r.jsx("div",{id:"uploadbd",children:r.jsxs("div",{id:"porcentagem",children:["Enviando:",P,"%"]})})}),r.jsx("div",{id:"m",style:{display:$?"flex":"none"},children:c.current?"Música alterada com sucesso.":"Música cadastrada com sucesso."}),r.jsx("div",{id:"errorImage",style:{display:H?"flex":"none"},children:"O tipo da imagem não corresponde a jpg/jpeg. Selecione uma imagem válida."}),r.jsx("div",{id:"errorCadastro",style:{display:W?"flex":"none"},children:"Adicione um arquivo de audio em todos os campos de música."})]})})}const fe=a.memo(oe);export{fe as default};
