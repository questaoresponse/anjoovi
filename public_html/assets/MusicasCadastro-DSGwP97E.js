import{r as a,u as ce,a as le,s as P,j as n}from"./index-CUhmS-5o.js";import{F as ue,f as de,t as N,P as fe}from"./Publicar-BlSIBL1L.js";/* empty css             */function me(){const S=ce(),{server:x,navigate:A}=S,b=le(),[z,O]=a.useState(!1),d=a.useRef(!1),k=a.useRef(),[H,E]=a.useState("Upload"),[J,q]=a.useState(!1),[W,M]=a.useState(!1),[G,K]=a.useState(0),[p,j]=a.useState([{titulo:"",input:a.createRef()}]),[y,w]=a.useState(!1),[Q,T]=a.useState(!1),[V,L]=a.useState(!1),g=a.useRef(new ue),f={titulo:a.useRef(null),imagem:a.useRef(null),imagem_view:a.useRef(null)},X=()=>{L(!0);const t=setTimeout(()=>{L(!1),clearTimeout(t)},2e3)},Y=()=>{T(!0);const t=setTimeout(()=>{T(!1),clearTimeout(t)},2e3)},[_,B]=a.useState({src:P,width:"100%",height:"100%"}),C=t=>{if(typeof t=="string"){const e=new Image;e.onload=()=>{const i=f.imagem_view.current.offsetWidth,o=f.imagem_view.current.offsetHeight;var c=e.width,r=e.height;i/c*r>o?(c=o/r*c,r=o):(r=i/c*r,c=i),B({src:t,width:c,height:r})},e.src=t}else B({src:P,width:window.innerWidth,height:window.innerHeight/1280*720})},Z=t=>{const e=t.target.files[0];if(e){const i=new FileReader;i.onloadend=()=>{const o=i.result instanceof ArrayBuffer?i.result:new ArrayBuffer(0),c=new Uint8Array(o),r={jpeg:[255,216,255],png:[137,80,78,71,13,10,26,10],gif:[71,73,70]};let s=null;for(const[l,v]of Object.entries(r))if(v.every((h,U)=>h===c[U])){s=l;break}if(s&&s=="jpeg"){E(e.name);const l=new FileReader;l.onloadend=()=>{C(l.result)},l.readAsDataURL(e)}else C(null),t.target.value="",Y()},i.readAsArrayBuffer(e)}},I=t=>{var e;d.current?e=Math.round(t.loaded*100/t.total)==100?99:Math.round(t.loaded*100/t.total):u.current.executed?e=50+(Math.round(t.loaded*100/t.total)>=100?49:Math.round(t.loaded*100/t.total/2)):e=Math.round(t),M(!0),K(e)},$=t=>{var e=new FormData;const i=f.imagem.current.files[0];e.append("type","option"),d.current&&e.append("id",k.current.id.toString()),i&&e.append("imagem",i),i&&e.append("imagens_edit","true"),e.append("titulo",f.titulo.current.value),t&&e.append("files",JSON.stringify(t)),b.post(x+"/admin/musicas_cadastro?type="+(d.current?"edit":"cadastro"),e,d.current?{arquivo:!0}:{arquivo:!0,porcentagem:I}).then(o=>{if(o.error)S.setRedirectError(o.error);else if(o.data.result=="true"){if(d.current){const r=new URLSearchParams(location.search);if(r.has("origin"))A(decodeURIComponent(r.get("origin")));else{const s=location.pathname.split("_");A(s[0]+"_lista")}d.current=!1,k.current=void 0}M(!1),u.current.executed=!1,q(!0);var c=setTimeout(()=>{q(!1),clearTimeout(c)},2e3);f.titulo.current.value="",f.imagem.current.value="",E("Upload"),j([{titulo:"",input:a.createRef()}]),C(null)}})},ee=a.useCallback(async t=>{if(t.preventDefault(),y||X(),!y)return;const e=[];var i=0,o={};async function c(r){const s=r.file,l=1024*1024,v=Math.ceil(s.size/l);for(let m=0;m<v;m++){const h=new FormData,U=m*l,ie=Math.min((m+1)*l,s.size),se=s.slice(U,ie);h.append("totalChunks",v.toString()),h.append("currentChunk",m.toString()),h.append("type","chunk"),h.append("filename",r.name),h.append("file",se,r.name),await b.post(x+"/admin/musicas_cadastro?type=chunk",h,{arquivo:!0}),o[r.name]=(m+1)/v,I({loaded:e.map(F=>o[F.name]).reduce((F,oe)=>F+oe,0)*100/e.length,total:100})}i+=1,i==e.length&&$(e.map(m=>m.name))}if(M(!0),d.current)$();else{for(const r of p){const s=r.input.current.files[0];if(s.type=="audio/x-m4a")D({progress:1}),e.push({file:s,name:s.name.split(".").slice(0,-1).join(".")+".m4a"});else{const l="input"+s.name.split(".").slice(-1).join(".");await g.current.writeFile(l,await de(s)),console.log("aian2"),await g.current.exec(["-i",l,"-vn","-c:a","aac","output.m4a"]),console.log("foie");const v=new Uint8Array(await g.current.readFile("output.m4a"));await g.current.deleteFile(l),await g.current.deleteFile("output.m4a");const m=new Blob([v.buffer],{type:"audio/m4a"});e.push({file:m,name:s.name.split(".").slice(0,-1).join(".")+".m4a"})}}u.current.executed=!0;for(const r of e)o[r.name]=0,c(r)}},[p,y]),D=a.useCallback(({progress:t})=>{u.current.finished==-1&&(u.current.finished=0);const e=50/u.current.length;I(e*u.current.finished+t/1*e),t==1&&u.current.length>u.current.finished&&u.current.finished++,u.current.length==u.current.finished&&(u.current.finished=-1)},[p]);d.current=location.pathname=="/admin/musicas_edit";const u=a.useRef({length:0,finished:0,executed:!1});a.useEffect(()=>{S.setSelected("publicar"),O(d.current),d.current?(w(!0),b.post(x+"/admin/musicas_edit"+location.search,{type:"info"}).then(t=>{if("post_edit"in t.data){f.imagem.current.required=!1;const e=t.data.post_edit[0];f.titulo.current.value=e.titulo,e.arquivo=JSON.parse(e.arquivo),j(Array.from({length:e.arquivo.length},(i,o)=>({titulo:e.arquivo[o].replace(/\.[^/.]+$/,""),input:a.createRef()}))),k.current=e,C(x+"/images/"+encodeURIComponent(e.imagem))}})):(async()=>{const t="https://unpkg.com/@ffmpeg/core-mt@0.12.6/dist/esm";g.current.on("progress",D),await g.current.load({coreURL:await N(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await N(`${t}/ffmpeg-core.wasm`,"application/wasm"),workerURL:await N(`${t}/ffmpeg-core.worker.js`,"text/javascript")}),console.log("carregado")})()},[]);const te=()=>{w(!1),j(t=>[...t,{titulo:"",input:a.createRef()}])},R=a.useRef([]);a.useEffect(()=>{if(p.length>1){for(const t of R.current){const e=new DataTransfer;e.items.add(t[1]),p[t[0]].input.current.files=e.files}R.current=[]}},[p]);const re=a.useCallback(t=>{if(!d.current){var e=0;j(i=>{const o=i[t].input.current.files.length;if(i=i.map((r,s)=>{if(t==s&&r.input.current.files.length>0){const l=r.input.current.files.length;return e+=l,s==i.length-1&&e==i.length+l-1&&w(!0),{...r,titulo:r.input.current.files[0].name.replace(/\.[^/.]+$/,"")}}else if(r.titulo!=""&&r.input.current.files.length>0)e++,s==i.length-1&&e==i.length&&w(!0);else if(r.titulo!=""&&r.input.current.files.length==0)return w(!1),{...r,titulo:""};return r}),o>0){const r=[];R.current=[];for(var c=1;c<o;c++){const s={titulo:i[t].input.current.files[c].name.replace(/\.[^/.]+$/,""),input:a.createRef()};R.current.push([t+c,i[t].input.current.files[c]]),r.push(s)}i.splice(t+1,0,...r)}return u.current.length=i.length,i})}},[p]),ne=a.useCallback(t=>{d.current||p[t].input.current.click()},[p]),ae=t=>{t>0&&!d.current&&j(e=>(e.length>1&&(e.splice(t,1),w(!0)),u.current.length=e.length,[...e]))};return n.jsx("div",{id:"pg",className:"mc",children:n.jsxs("div",{id:"dt",className:"fechado",children:[n.jsx(fe,{}),n.jsx("div",{id:"msg1",children:"Cadastrar música"}),n.jsxs("form",{onSubmit:ee,children:[n.jsx("label",{children:"Título"}),n.jsx("input",{ref:f.titulo,className:"input",id:"titulo",placeholder:"Insira um título",required:!0}),n.jsx("label",{children:"Música"}),n.jsx("div",{className:"list-music"+(z?" edit":""),children:p.map((t,e)=>n.jsxs("div",{className:"item-music"+(e==0?" first":""),children:[n.jsx("div",{className:"count-music",children:e+1}),n.jsx("div",{className:"title-music",children:t.titulo}),n.jsx("input",{onChange:()=>{re(e)},ref:t.input,className:"input-music",type:"file",accept:"audio/*",multiple:!0}),n.jsx("div",{onClick:()=>{ne(e)},className:"add-music",children:"+"}),n.jsx("div",{onClick:()=>{ae(e)},className:"remove-music",children:"-"})]},e))}),n.jsx("div",{style:{display:y?"block":"none"},id:"add-list-music",onClick:te,children:"Adicionar"}),n.jsx("label",{children:"Capa"}),n.jsxs("div",{id:"imagem-div",children:[n.jsx("div",{ref:f.imagem_view,id:"imagem-view",children:n.jsx("img",{className:"col-12 col-md-6",style:{width:_.width,height:_.height},src:_.src})}),n.jsx("input",{className:"file",ref:f.imagem,onChange:Z,type:"file",accept:"image/jpg, image/jpeg",required:!0}),n.jsx("div",{id:"imagem-pt",children:n.jsx("div",{id:"imagem",onClick:()=>{f.imagem.current.click()},children:n.jsx("div",{className:"txt-1",children:H})})})]}),n.jsx("button",{type:"submit",id:"button",children:"Enviar"})]}),n.jsx("div",{id:"uploadd",style:{display:W?"flex":"none"},children:n.jsx("div",{id:"uploadbd",children:n.jsxs("div",{id:"porcentagem",children:["Enviando:",G,"%"]})})}),n.jsx("div",{id:"m",style:{display:J?"flex":"none"},children:d.current?"Música alterada com sucesso.":"Música cadastrada com sucesso."}),n.jsx("div",{id:"errorImage",style:{display:Q?"flex":"none"},children:"O tipo da imagem não corresponde a jpg/jpeg. Selecione uma imagem válida."}),n.jsx("div",{id:"errorCadastro",style:{display:V?"flex":"none"},children:"Adicione um arquivo de audio em todos os campos de música."})]})})}const ve=a.memo(me);export{ve as default};
