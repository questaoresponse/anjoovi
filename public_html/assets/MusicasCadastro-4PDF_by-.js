import{r as a,u as ie,a as se,s as D,j as n}from"./index-CTt7U_mL.js";import{F as oe,f as ce,t as U,P as le}from"./Publicar-CmE_-7v7.js";/* empty css             */function ue(){const R=ie(),{server:j,navigate:F}=R,S=se(),[P,z]=a.useState(!1),u=a.useRef(!1),b=a.useRef(),[O,N]=a.useState("Upload"),[H,A]=a.useState(!1),[J,k]=a.useState(!1),[W,G]=a.useState(0),[p,w]=a.useState([{titulo:"",input:a.createRef()}]),[x,v]=a.useState(!1),[K,E]=a.useState(!1),[Q,q]=a.useState(!1),h=a.useRef(new oe),f={titulo:a.useRef(null),imagem:a.useRef(null),imagem_view:a.useRef(null)},V=()=>{q(!0);const t=setTimeout(()=>{q(!1),clearTimeout(t)},2e3)},X=()=>{E(!0);const t=setTimeout(()=>{E(!1),clearTimeout(t)},2e3)},[M,T]=a.useState({src:D,width:"100%",height:"100%"}),y=t=>{if(typeof t=="string"){const e=new Image;e.onload=()=>{const i=f.imagem_view.current.offsetWidth,c=f.imagem_view.current.offsetHeight;var s=e.width,r=e.height;i/s*r>c?(s=c/r*s,r=c):(r=i/s*r,s=i),T({src:t,width:s,height:r})},e.src=t}else T({src:D,width:window.innerWidth,height:window.innerHeight/1280*720})},Y=t=>{const e=t.target.files[0];if(e){const i=new FileReader;i.onloadend=()=>{const c=i.result instanceof ArrayBuffer?i.result:new ArrayBuffer(0),s=new Uint8Array(c),r={jpeg:[255,216,255],png:[137,80,78,71,13,10,26,10],gif:[71,73,70]};let o=null;for(const[d,m]of Object.entries(r))if(m.every((_,I)=>_===s[I])){o=d;break}if(o&&o=="jpeg"){N(e.name);const d=new FileReader;d.onloadend=()=>{y(d.result)},d.readAsDataURL(e)}else y(null),t.target.value="",X()},i.readAsArrayBuffer(e)}},L=t=>{var e;u.current?e=Math.round(t.loaded*100/t.total)==100?99:Math.round(t.loaded*100/t.total):l.current.executed?e=50+(Math.round(t.loaded*100/t.total)>=100?49:Math.round(t.loaded*100/t.total/2)):e=Math.round(t),k(!0),G(e)},B=t=>{var e=new FormData;const i=f.imagem.current.files[0];e.append("type","option"),u.current&&e.append("id",b.current.id.toString()),i&&e.append("imagem",i),i&&e.append("imagens_edit","true"),e.append("titulo",f.titulo.current.value),t&&e.append("files",JSON.stringify(t)),S.post(j+"/admin/musicas_cadastro?type="+(u.current?"edit":"cadastro"),e,u.current?{arquivo:!0}:{arquivo:!0,porcentagem:L}).then(c=>{if(c.error)R.setRedirectError(c.error);else if(c.data.result=="true"){if(u.current){const r=new URLSearchParams(location.search);if(r.has("origin"))F(decodeURIComponent(r.get("origin")));else{const o=location.pathname.split("_");F(o[0]+"_lista")}u.current=!1,b.current=void 0}k(!1),l.current.executed=!1,A(!0);var s=setTimeout(()=>{A(!1),clearTimeout(s)},2e3);f.titulo.current.value="",f.imagem.current.value="",N("Upload"),w([{titulo:"",input:a.createRef()}]),y(null)}})},Z=a.useCallback(async t=>{if(t.preventDefault(),x||V(),!x)return;const e=[];var i=0;async function c(s){const r=s.file,o=1024*1024,d=Math.ceil(r.size/o);for(let m=0;m<d;m++){const g=new FormData,_=m*o,I=Math.min((m+1)*o,r.size),ae=r.slice(_,I);g.append("totalChunks",d.toString()),g.append("currentChunk",m.toString()),g.append("type","chunk"),g.append("filename",s.name),g.append("file",ae,s.name),await S.post(j+"/admin/musicas_cadastro?type=chunk",g,{arquivo:!0})}i+=1,i==e.length&&B(e.map(m=>m.name))}if(k(!0),u.current)B();else{for(const s of p){const r=s.input.current.files[0];if(r.type=="audio/x-m4a")$({progress:1}),e.push({file:r,name:r.name.split(".").slice(0,-1).join(".")+".m4a"});else{const o="input"+r.name.split(".").slice(-1).join(".");await h.current.writeFile(o,await ce(r)),console.log("aian2"),await h.current.exec(["-i",o,"-vn","-c:a","aac","output.m4a"]),console.log("foie");const d=new Uint8Array(await h.current.readFile("output.m4a"));await h.current.deleteFile(o),await h.current.deleteFile("output.m4a");const m=new Blob([d.buffer],{type:"audio/m4a"});e.push({file:m,name:r.name.split(".").slice(0,-1).join(".")+".m4a"})}}l.current.executed=!0;for(const s of e)c(s)}},[p,x]),$=a.useCallback(({progress:t})=>{l.current.finished==-1&&(l.current.finished=0);const e=50/l.current.length;L(e*l.current.finished+t/1*e),t==1&&l.current.length>l.current.finished&&l.current.finished++,l.current.length==l.current.finished&&(l.current.finished=-1)},[p]);u.current=location.pathname=="/admin/musicas_edit";const l=a.useRef({length:0,finished:0,executed:!1});a.useEffect(()=>{R.setSelected("publicar"),z(u.current),u.current?(v(!0),S.post(j+"/admin/musicas_edit"+location.search,{type:"info"}).then(t=>{if("post_edit"in t.data){f.imagem.current.required=!1;const e=t.data.post_edit[0];f.titulo.current.value=e.titulo,e.arquivo=JSON.parse(e.arquivo),w(Array.from({length:e.arquivo.length},(i,c)=>({titulo:e.arquivo[c].replace(/\.[^/.]+$/,""),input:a.createRef()}))),b.current=e,y(j+"/images/"+encodeURIComponent(e.imagem))}})):(async()=>{const t="https://unpkg.com/@ffmpeg/core-mt@0.12.6/dist/esm";h.current.on("progress",$),await h.current.load({coreURL:await U(`${t}/ffmpeg-core.js`,"text/javascript"),wasmURL:await U(`${t}/ffmpeg-core.wasm`,"application/wasm"),workerURL:await U(`${t}/ffmpeg-core.worker.js`,"text/javascript")}),console.log("carregado")})()},[]);const ee=()=>{v(!1),w(t=>[...t,{titulo:"",input:a.createRef()}])},C=a.useRef([]);a.useEffect(()=>{if(p.length>1){for(const t of C.current){const e=new DataTransfer;e.items.add(t[1]),p[t[0]].input.current.files=e.files}C.current=[]}},[p]);const te=a.useCallback(t=>{if(!u.current){var e=0;w(i=>{const c=i[t].input.current.files.length;if(i=i.map((r,o)=>{if(t==o&&r.input.current.files.length>0){const d=r.input.current.files.length;return e+=d,o==i.length-1&&e==i.length+d-1&&v(!0),{...r,titulo:r.input.current.files[0].name.replace(/\.[^/.]+$/,"")}}else if(r.titulo!=""&&r.input.current.files.length>0)e++,o==i.length-1&&e==i.length&&v(!0);else if(r.titulo!=""&&r.input.current.files.length==0)return v(!1),{...r,titulo:""};return r}),c>0){const r=[];C.current=[];for(var s=1;s<c;s++){const o={titulo:i[t].input.current.files[s].name.replace(/\.[^/.]+$/,""),input:a.createRef()};C.current.push([t+s,i[t].input.current.files[s]]),r.push(o)}i.splice(t+1,0,...r)}return l.current.length=i.length,i})}},[p]),re=a.useCallback(t=>{u.current||p[t].input.current.click()},[p]),ne=t=>{t>0&&!u.current&&w(e=>(e.length>1&&(e.splice(t,1),v(!0)),l.current.length=e.length,[...e]))};return n.jsx("div",{id:"pg",className:"mc",children:n.jsxs("div",{id:"dt",className:"fechado",children:[n.jsx(le,{}),n.jsx("div",{id:"msg1",children:"Cadastrar música"}),n.jsxs("form",{onSubmit:Z,children:[n.jsx("label",{children:"Título"}),n.jsx("input",{ref:f.titulo,className:"input",id:"titulo",placeholder:"Insira um título",required:!0}),n.jsx("label",{children:"Música"}),n.jsx("div",{className:"list-music"+(P?" edit":""),children:p.map((t,e)=>n.jsxs("div",{className:"item-music"+(e==0?" first":""),children:[n.jsx("div",{className:"count-music",children:e+1}),n.jsx("div",{className:"title-music",children:t.titulo}),n.jsx("input",{onChange:()=>{te(e)},ref:t.input,className:"input-music",type:"file",accept:"audio/*",multiple:!0}),n.jsx("div",{onClick:()=>{re(e)},className:"add-music",children:"+"}),n.jsx("div",{onClick:()=>{ne(e)},className:"remove-music",children:"-"})]},e))}),n.jsx("div",{style:{display:x?"block":"none"},id:"add-list-music",onClick:ee,children:"Adicionar"}),n.jsx("label",{children:"Capa"}),n.jsxs("div",{id:"imagem-div",children:[n.jsx("div",{ref:f.imagem_view,id:"imagem-view",children:n.jsx("img",{className:"col-12 col-md-6",style:{width:M.width,height:M.height},src:M.src})}),n.jsx("input",{className:"file",ref:f.imagem,onChange:Y,type:"file",accept:"image/jpg, image/jpeg",required:!0}),n.jsx("div",{id:"imagem-pt",children:n.jsx("div",{id:"imagem",onClick:()=>{f.imagem.current.click()},children:n.jsx("div",{className:"txt-1",children:O})})})]}),n.jsx("button",{type:"submit",id:"button",children:"Enviar"})]}),n.jsx("div",{id:"uploadd",style:{display:J?"flex":"none"},children:n.jsx("div",{id:"uploadbd",children:n.jsxs("div",{id:"porcentagem",children:["Enviando:",W,"%"]})})}),n.jsx("div",{id:"m",style:{display:H?"flex":"none"},children:u.current?"Música alterada com sucesso.":"Música cadastrada com sucesso."}),n.jsx("div",{id:"errorImage",style:{display:K?"flex":"none"},children:"O tipo da imagem não corresponde a jpg/jpeg. Selecione uma imagem válida."}),n.jsx("div",{id:"errorCadastro",style:{display:Q?"flex":"none"},children:"Adicione um arquivo de audio em todos os campos de música."})]})})}const pe=a.memo(ue);export{pe as default};
